<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 
#ConfigSection
데이터베이스에 질의할 구문을 작성하는곳
 -->

<mapper namespace="menus">
	<select id="menuList" parameterType="map" resultType="map">

		SELECT 	a.rol_cd, b.system_cd, b.menu_cd, menu_nm = b.title, b.frm_cd,
				a.read_yn, a.add_yn, a.mod_yn, a.del_yn, a.prt_yn, a.hid_yn, a.cid,
				lv = 0
		INTO	#temp
		FROM	scm100 b
				LEFT OUTER JOIN scm150 a
								ON	a.system_cd  = b.system_cd
								AND	a.menu_cd = b.menu_cd
								AND	a.rol_cd = (select top 1 rol_cd from scr150 where reg_id = #{reg_id} group by reg_id,mdt,rol_cd order by reg_id, mdt desc)
		WHERE  	b.system_cd  = 'Smart'
			AND	b.menu_cd in (select a.menu_cd FROM	scm100 a LEFT JOIN scf100 b ON	b.frm_cd = a.frm_cd	WHERE	a.system_cd  = 'Smart' and isnull(a.up_cd,'')='' )
		
		DECLARE	@_lv INT, @_cnt INT
		
		SET	@_lv = 0
		SET	@_cnt = 1
	
		WHILE @_cnt > 0  
		BEGIN
			INSERT INTO #temp
			SELECT 	a.rol_cd, b.system_cd, b.menu_cd, menu_nm = b.title, b.frm_cd,
				a.read_yn, a.add_yn, a.mod_yn, a.del_yn, a.prt_yn, a.hid_yn, a.cid,
				lv = @_lv + 1
			FROM	scm100 b
					LEFT OUTER JOIN scm150 a
									ON	a.system_cd  = b.system_cd
									AND	a.menu_cd = b.menu_cd
									AND	a.rol_cd = (select top 1 rol_cd from scr150 where reg_id = #{reg_id} group by reg_id,mdt,rol_cd order by reg_id, mdt desc)		
					INNER JOIN	#temp x
								ON	x.menu_cd = b.up_cd
			WHERE 	x.lv = @_lv
			AND	b.system_cd  = 'Smart'
			AND	b.app_yn = '1'

			SET	@_lv = @_lv + 1

			SELECT	@_cnt = COUNT(0) 
			FROM	#temp 
			WHERE 	lv = @_lv
		END

SELECT 
	c.lv,
	c.rol_cd,

	a.system_cd, a.up_cd, a.menu_cd, a.title,
	a.line_yn, a.use_yn, a.app_yn,
	a.hid_yn as m_hid_yn, 
		 
	c.read_yn, 
	c.add_yn,
	c.mod_yn,
	c.del_yn,
	c.prt_yn ,
	c.all_yn ,
	c.cid, 	
	c.frm_cd, 
	
	form_nm = b.name,
	m1 = (select count(0) from scu200 z		where	z.use_dt >= dateadd(month, -1, getdate()) and	z.frm_cd = a.frm_cd)
FROM	scm100 a
	left JOIN scf100 b
	ON	b.frm_cd = a.frm_cd
	left join (  SELECT	
					rol_cd, system_cd, frm_cd, menu_cd, 
					menu_nm = SPACE(lv*2) + menu_nm, 
					read_yn = ISNULL(read_yn,'0'), 
					add_yn  = ISNULL(add_yn, '0'), 
					mod_yn  = ISNULL(mod_yn, '0'), 
					del_yn  = ISNULL(del_yn, '0'), 
					prt_yn  = ISNULL(prt_yn, '0'), 
					hid_yn = ISNULL(hid_yn,'0'), 
					all_yn  = CASE WHEN 	ISNULL(read_yn,'0') = '1' OR 
								ISNULL(add_yn, '0') = '1' OR 
								ISNULL(mod_yn, '0') = '1' OR 
								ISNULL(del_yn, '0') = '1' OR 
								ISNULL(prt_yn, '0') = '1' THEN
								'1'
								ELSE
								'0'
							END,
					cid, lv
				FROM 	#temp
			) c on a.menu_cd = c.menu_cd
WHERE	a.system_cd  = 'Smart'
ORDER BY menu_cd
drop table #temp
	</select>	
</mapper>


<!-- 
USERNO INT GENERATED BY DEFAULT AS IDENTITY 
          (START WITH 1, INCREMENT BY 1) NOT NULL,
    USERID VARCHAR(45) NOT NULL,
	USERNAME VARCHAR(45) NOT NULL,
	PASSWORD VARCHAR(45) NOT NULL,
 -->